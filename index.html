<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Visor de Incendios Urbanos</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
  body, html { margin:0; padding:0; height:100%; font-family: Arial, sans-serif; }
  #map { height: 70vh; }
  #controls { padding: 10px; }
  #results { max-height: 25vh; overflow-y: auto; margin-top: 10px; border: 1px solid #ccc; padding: 5px; font-size: 14px; }
  .legend { background: white; padding: 6px; line-height: 1.4em; }
  .legend-color { display: inline-block; width: 15px; height: 15px; margin-right: 6px; vertical-align: middle; }
</style>
</head>
<body>

<h2 style="text-align:center; margin:10px;">Visor de Incendios Urbanos - Ciudad de México</h2>

<div id="map"></div>

<div id="controls">
  <button id="toggleRadiusBtn">Activar modo radio 500m</button>
  <div id="results">Resultados aquí...</div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- Load GeoJSON with fetch API -->

<script>
  // Inicializar mapa
  var map = L.map('map').setView([19.43, -99.13], 11);

  // Capa base
  var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap'
  }).addTo(map);

  // Variables
  var geojsonUrl = 'Incendios Urbanos 2022.geojson'; // archivo en misma carpeta
  var incendioLayer;
  var radiusCircle;
  var modoRadio = false;
  var resultsDiv = document.getElementById('results');
  var toggleBtn = document.getElementById('toggleRadiusBtn');

  // Colores para clasificación (puedes ajustar)
  var colores = {
    'Quema de basura': '#FF5733',
    'Casa habitacion': '#33C1FF',
    'Vehiculo': '#33FF49',
    'Arbol': '#B533FF',
    'Industria': '#FFC733',
    'Edificio': '#FF33A8',
    'Negocio plaza comercial mercado': '#3385FF',
    'Otros': '#888888'
  };

  // Función para elegir color según incidente
  function getColor(tipo) {
    return colores[tipo] || colores['Otros'];
  }

  // Función para crear popup info
  function onEachFeature(feature, layer) {
    var props = feature.properties;
    var html = '<b>Incidente:</b> ' + props.incidente_c4 + '<br>' +
               '<b>Alcaldía:</b> ' + props.alcaldia_cierre + '<br>' +
               '<b>Colonia:</b> ' + props.colonia_cierre;
    layer.bindPopup(html);
  }

  // Cargar GeoJSON y crear layer
  fetch(geojsonUrl)
    .then(response => response.json())
    .then(data => {
      incendioLayer = L.geoJSON(data, {
        pointToLayer: function(feature, latlng) {
          return L.circleMarker(latlng, {
            radius: 6,
            fillColor: getColor(feature.properties.incidente_c4),
            color: '#000',
            weight: 1,
            fillOpacity: 0.8
          });
        },
        onEachFeature: onEachFeature
      }).addTo(map);

      agregarLeyenda();
    })
    .catch(err => {
      resultsDiv.innerHTML = "Error cargando datos: " + err;
    });

  // Leyenda
  function agregarLeyenda() {
    var legend = L.control({position: 'bottomright'});
    legend.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'legend');
      div.innerHTML = '<b>Incidentes</b><br>';
      for (var tipo in colores) {
        div.innerHTML +=
          '<span class="legend-color" style="background:' + colores[tipo] + '"></span>' +
          tipo + '<br>';
      }
      return div;
    };
    legend.addTo(map);
  }

  // Manejo del modo radio 500m
  toggleBtn.onclick = function() {
    modoRadio = !modoRadio;
    if (modoRadio) {
      this.textContent = "Modo radio activado: haz clic en el mapa";
      resultsDiv.innerHTML = "Haz clic en el mapa para trazar un radio de 500 metros y filtrar incidentes.";
      map.on('click', onMapClickRadio);
    } else {
      this.textContent = "Activar modo radio 500m";
      resultsDiv.innerHTML = "Modo radio desactivado.";
      map.off('click', onMapClickRadio);
      if (radiusCircle) {
        map.removeLayer(radiusCircle);
        radiusCircle = null;
      }
      // Restaurar todos los puntos visibles
      if (incendioLayer) incendioLayer.eachLayer(function(layer) {
        layer.setStyle({opacity:1, fillOpacity:0.8});
      });
    }
  };

  // Al hacer click en el mapa en modo radio
  function onMapClickRadio(e) {
    if (radiusCircle) map.removeLayer(radiusCircle);

    radiusCircle = L.circle(e.latlng, {radius: 500, color: 'red', weight: 2, fillOpacity: 0.1}).addTo(map);

    // Filtrar puntos dentro del radio
    var puntosDentro = [];
    incendioLayer.eachLayer(function(layer) {
      var distancia = map.distance(e.latlng, layer.getLatLng());
      if (distancia <= 500) {
        layer.setStyle({opacity:1, fillOpacity:0.8});
        puntosDentro.push(layer.feature.properties);
      } else {
        layer.setStyle({opacity:0.2, fillOpacity:0.1});
      }
    });

    // Mostrar resultados en tabla simplificada
    mostrarResultados(puntosDentro);
  }

  // Mostrar resultados en div
  function mostrarResultados(puntos) {
    if (puntos.length === 0) {
      resultsDiv.innerHTML = "No se encontraron incidentes dentro del radio de 500m.";
      return;
    }
    var html = '<b>Incidentes dentro de 500m: ' + puntos.length + '</b><br><table border="1" cellpadding="3" style="border-collapse: collapse; width: 100%;">';
    html += '<tr><th>Incidente</th><th>Alcaldía</th><th>Colonia</th></tr>';
    puntos.forEach(function(p) {
      html += '<tr><td>' + p.incidente_c4 + '</td><td>' + p.alcaldia_cierre + '</td><td>' + p.colonia_cierre + '</td></tr>';
    });
    html += '</table>';

    // Aquí puedes agregar el cálculo básico de probabilidad, impacto y riesgo según cantidad
    // Por ejemplo:
    var probabilidad = 'Bajo', impacto = 'Bajo', riesgo = 'Bajo';
    if (puntos.length > 50) {
      probabilidad = 'Alto';
      impacto = 'Alto';
      riesgo = 'Alto';
    } else if (puntos.length > 20) {
      probabilidad = 'Medio';
      impacto = 'Medio';
      riesgo = 'Medio';
    }
    html += `<br><b>Probabilidad:</b> ${probabilidad} | <b>Impacto:</b> ${impacto} | <b>Riesgo:</b> ${riesgo}`;

    resultsDiv.innerHTML = html;
  }
</script>

</body>
</html>
