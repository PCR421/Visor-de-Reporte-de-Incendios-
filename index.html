<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Visor de Incendios Urbanos CDMX</title>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  crossorigin=""
/>
<!-- Leaflet Control Geocoder CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"
/>

<style>
  body, html {
    margin: 0; 
    height: 100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f8f9fa;
    display: flex;
    flex-direction: column;
  }
  #titulo {
    padding: 10px 20px;
    background: #003366;
    color: white;
    font-size: 1.5rem;
    font-weight: 700;
    user-select: none;
  }
  #radioBtn {
    position: absolute;
    top: 160px; /* lo bajÃ© 100px mÃ¡s */
    left: 10px;
    background: white;
    padding: 8px 14px;
    cursor: pointer;
    border: 2px solid #666;
    border-radius: 5px;
    font-weight: bold;
    z-index: 1000;
    user-select: none;
    box-shadow: 1px 1px 5px rgba(0,0,0,0.3);
  }
  #radioBtn.active {
    background: #d9534f;
    color: white;
    border-color: #b52b27;
  }
  .leaflet-control-layers {
    margin-top: 110px !important; /* para que no se pise con el botÃ³n */
    z-index: 1000;
  }
  #map { 
    height: 60vh; 
    width: 100%;
    position: relative;
    z-index: 0;
  }

  #tablaContenedor {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    max-height: 30vh;
    overflow-y: auto;
    box-shadow: 0 -3px 15px rgba(0,0,0,0.2);
    background: white;
    z-index: 1500;
  }

  #tablaResultados {
    border-collapse: collapse;
    width: 100%;
    font-size: 0.9rem;
  }

  #tablaResultados th, #tablaResultados td {
    border: 1px solid #ccc;
    padding: 8px 12px;
    text-align: left;
  }
  #tablaResultados th {
    background-color: #003366;
    color: white;
    position: sticky;
    top: 0;
    z-index: 1;
  }

  /* Colores para leyenda y cÃ­rculos */
  .leyenda {
    display: flex;
    flex-wrap: wrap;
    margin: 10px 20px;
    gap: 15px;
    user-select: none;
  }
  .item-leyenda {
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 600;
    font-size: 0.9rem;
  }
  .color-box {
    width: 16px;
    height: 16px;
    border-radius: 3px;
  }
</style>
</head>
<body>

<div id="titulo">Visor de Incendios Urbanos CDMX</div>
<div id="radioBtn" onclick="activarHerramientaRadio()">ðŸŽ¯ Activar Radio</div>
<div id="map"></div>

<div class="leyenda" id="leyenda">
  <!-- Se rellenarÃ¡ con leyenda dinÃ¡mica -->
</div>

<div id="tablaContenedor" hidden>
  <table id="tablaResultados">
    <thead>
      <tr>
        <th>Incidente</th>
        <th>AlcaldÃ­a</th>
        <th>Colonia</th>
        <th>Latitud</th>
        <th>Longitud</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<!-- Leaflet Control Geocoder JS -->
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
  const map = L.map('map').setView([19.4, -99.14], 11);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: 'Â© OpenStreetMap'
  }).addTo(map);

  // AÃ±adir buscador con Leaflet Control Geocoder
  const geocoder = L.Control.geocoder({
    defaultMarkGeocode: false,
    placeholder: 'Buscar lugar...'
  })
  .on('markgeocode', function(e) {
    const bbox = e.geocode.bbox;
    const poly = L.polygon([
      bbox.getSouthEast(),
      bbox.getNorthEast(),
      bbox.getNorthWest(),
      bbox.getSouthWest()
    ]).addTo(map);
    map.fitBounds(poly.getBounds());
    setTimeout(() => map.removeLayer(poly), 5000); // elimina el polÃ­gono despuÃ©s de 5 segundos
  })
  .addTo(map);

  let modoRadio = false;
  let radioCapa = null;

  // Colores Ãºnicos para tipos de incidentes
  const coloresIncidentes = {
    "Quema de basura": "#e67e22",
    "Casa habitacion": "#2980b9",
    "Vehiculo": "#27ae60",
    "Arbol": "#16a085",
    "Industria": "#8e44ad",
    "Edificio": "#c0392b",
    "Negocio plaza comercial mercado": "#d35400",
    "Otro": "#7f8c8d"
  };

  // Objetos para subcapas segÃºn tipo
  let subcapas = {};

  // Cargar GeoJSON y crear subcapas
  fetch('Incendios Urbanos 2022.geojson')
    .then(res => res.json())
    .then(data => {
      data.features.forEach(feature => {
        let tipo = feature.properties.incidente_c4 || "Otro";
        if (!coloresIncidentes[tipo]) tipo = "Otro";

        if (!subcapas[tipo]) {
          subcapas[tipo] = L.layerGroup();
        }

        // Ojo que las coordenadas vienen [lng, lat], no [lat, lng]
        let latlng = [feature.geometry.coordinates[1], feature.geometry.coordinates[0]];

        let marker = L.circleMarker(latlng, {
          radius: 6,
          fillColor: coloresIncidentes[tipo],
          color: '#000',
          weight: 1,
          opacity: 1,
          fillOpacity: 0.8
        });

        marker.bindPopup(
          `<b>Incidente:</b> ${feature.properties.incidente_c4}<br>` +
          `<b>AlcaldÃ­a:</b> ${feature.properties.alcaldia_cierre}<br>` +
          `<b>Colonia:</b> ${feature.properties.colonia_cierre}`
        );

        subcapas[tipo].addLayer(marker);
      });

      // Agregar todas las subcapas al mapa y al control de capas
      let capasControl = {};
      for (const tipo in subcapas) {
        subcapas[tipo].addTo(map);
        capasControl[tipo] = subcapas[tipo];
      }

      L.control.layers(null, capasControl, { collapsed: false }).addTo(map);

      // Crear leyenda dinÃ¡mica
      const leyendaDiv = document.getElementById('leyenda');
      leyendaDiv.innerHTML = '';
      for (const tipo in coloresIncidentes) {
        const color = coloresIncidentes[tipo];
        const div = document.createElement('div');
        div.className = 'item-leyenda';
        div.innerHTML = `<div class="color-box" style="background:${color}"></div>${tipo}`;
        leyendaDiv.appendChild(div);
      }
    })
    .catch(err => alert('Error cargando GeoJSON: ' + err));

  function activarHerramientaRadio() {
    modoRadio = !modoRadio;
    const radioBtn = document.getElementById('radioBtn');
    radioBtn.classList.toggle('active');
    radioBtn.textContent = modoRadio ? 'ðŸ›‘ Cancelar Radio' : 'ðŸŽ¯ Activar Radio';
    if (radioCapa) {
      map.removeLayer(radioCapa);
      radioCapa = null;
    }
    limpiarTabla();
  }

  function limpiarTabla() {
    const tbody = document.querySelector('#tablaResultados tbody');
    tbody.innerHTML = '';
    document.getElementById('tablaContenedor').hidden = true;
  }

  map.on('click', function(e) {
    if (!modoRadio) return;

    if (radioCapa) {
      map.removeLayer(radioCapa);
      radioCapa = null;
    }

    radioCapa = L.circle(e.latlng, {
      radius: 500,
      color: 'red',
      fillColor: '#f03',
      fillOpacity: 0.2
    }).addTo(map);

    let conteo = 0;
    let resultados = [];

    // Para cada subcapa que estÃ© visible, buscar puntos dentro del radio
    for (const tipo in subcapas) {
      if (map.hasLayer(subcapas[tipo])) {
        subcapas[tipo].eachLayer(function(layer) {
          if (layer.getLatLng && e.latlng.distanceTo(layer.getLatLng()) <= 500) {
            conteo++;
            resultados.push({
              incidente: tipo,
              alcaldia: layer.getPopup().getContent().match(/<b>AlcaldÃ­a:<\/b> ([^<]+)/)[1],
              colonia: layer.getPopup().getContent().match(/<b>Colonia:<\/b> ([^<]+)/)[1],
              latitud: layer.getLatLng().lat.toFixed(6),
              longitud: layer.getLatLng().lng.toFixed(6)
            });
          }
        });
      }
    }

    // Mostrar conteo en popup
    radioCapa.bindPopup(`Incidentes en el radio: <strong>${conteo}</strong>`).openPopup();

    // Actualizar tabla con resultados
    const tbody = document.querySelector('#tablaResultados tbody');
    tbody.innerHTML = '';
    if (resultados.length > 0) {
      resultados.forEach(r => {
        let tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.incidente}</td><td>${r.alcaldia}</td><td>${r.colonia}</td><td>${r.latitud}</td><td>${r.longitud}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('tablaContenedor').hidden = false;
    } else {
      document.getElementById('tablaContenedor').hidden = true;
    }
  });
</script>

</body>
</html>
