<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visor de Incendios Urbanos CDMX</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

  <style>
    body, html {
      margin: 0;
      height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
    }
    #titulo {
      padding: 10px 20px;
      background: #003366;
      color: white;
      font-size: 1.5rem;
      font-weight: 700;
    }
    #radioBtn {
      position: absolute;
      top: 160px; /* bajado 100px mÃ¡s */
      left: 10px;
      background: white;
      padding: 8px 14px;
      cursor: pointer;
      border: 2px solid #666;
      border-radius: 5px;
      font-weight: bold;
      z-index: 1000;
      user-select: none;
      box-shadow: 1px 1px 5px rgba(0,0,0,0.3);
    }
    #radioBtn.active {
      background: #d9534f;
      color: white;
      border-color: #b52b27;
    }
    .leaflet-control-layers {
      margin-top: 210px !important;
    }
    #map {
      height: 65vh;
      width: 100%;
    }
    #tablaResultados {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      max-height: 30vh;
      overflow-y: auto;
      margin: 0;
      border-collapse: collapse;
      font-size: 0.9rem;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
      z-index: 999;
    }
    #tablaResultados th, #tablaResultados td {
      border: 1px solid #ccc;
      padding: 6px 10px;
      text-align: left;
    }
    #tablaResultados th {
      background-color: #003366;
      color: white;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .leyenda {
      display: flex;
      flex-wrap: wrap;
      margin: 10px 20px;
      gap: 15px;
    }
    .item-leyenda {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      font-size: 0.9rem;
    }
    .color-box {
      width: 16px;
      height: 16px;
      border-radius: 3px;
    }
  </style>
</head>
<body>

<div id="titulo">Visor de Incendios Urbanos CDMX</div>
<div id="radioBtn" onclick="activarHerramientaRadio()">ðŸŽ¯ Activar Radio</div>
<div id="map"></div>
<div class="leyenda" id="leyenda"></div>

<table id="tablaResultados" hidden>
  <thead>
    <tr>
      <th>Incidente</th>
      <th>AlcaldÃ­a</th>
      <th>Colonia</th>
      <th>Latitud</th>
      <th>Longitud</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<!-- Buscador -->
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
  const map = L.map('map').setView([19.4, -99.14], 11);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: 'Â© OpenStreetMap'
  }).addTo(map);

  // Buscador
  L.Control.geocoder().addTo(map);

  let modoRadio = false;
  let radioCapa = null;
  const coloresIncidentes = {
    "Quema de basura": "#e67e22",
    "Casa habitacion": "#2980b9",
    "Vehiculo": "#27ae60",
    "Arbol": "#16a085",
    "Industria": "#8e44ad",
    "Edificio": "#c0392b",
    "Negocio plaza comercial mercado": "#d35400",
    "Otro": "#7f8c8d"
  };
  let subcapas = {};

  fetch('Incendios Urbanos 2022.geojson')
    .then(res => res.json())
    .then(data => {
      data.features.forEach(feature => {
        let tipo = feature.properties.incidente_c4 || "Otro";
        if (!coloresIncidentes[tipo]) tipo = "Otro";
        if (!subcapas[tipo]) subcapas[tipo] = L.layerGroup();

        const coords = feature.geometry.coordinates;
        const latlng = [coords[1], coords[0]];

        const marker = L.circleMarker(latlng, {
          radius: 6,
          fillColor: coloresIncidentes[tipo],
          color: '#000',
          weight: 1,
          fillOpacity: 0.8
        }).bindPopup(
          `<b>Incidente:</b> ${feature.properties.incidente_c4}<br>` +
          `<b>AlcaldÃ­a:</b> ${feature.properties.alcaldia_cierre}<br>` +
          `<b>Colonia:</b> ${feature.properties.colonia_cierre}`
        );

        subcapas[tipo].addLayer(marker);
      });

      const capasControl = {};
      for (const tipo in subcapas) {
        subcapas[tipo].addTo(map);
        capasControl[tipo] = subcapas[tipo];
      }

      L.control.layers(null, capasControl, { collapsed: false }).addTo(map);

      const leyendaDiv = document.getElementById('leyenda');
      for (const tipo in coloresIncidentes) {
        const color = coloresIncidentes[tipo];
        const div = document.createElement('div');
        div.className = 'item-leyenda';
        div.innerHTML = `<div class="color-box" style="background:${color}"></div>${tipo}`;
        leyendaDiv.appendChild(div);
      }
    });

  function activarHerramientaRadio() {
    modoRadio = !modoRadio;
    const btn = document.getElementById('radioBtn');
    btn.classList.toggle('active');
    btn.textContent = modoRadio ? 'ðŸ›‘ Cancelar Radio' : 'ðŸŽ¯ Activar Radio';
    if (radioCapa) {
      map.removeLayer(radioCapa);
      radioCapa = null;
    }
    limpiarTabla();
  }

  function limpiarTabla() {
    const tbody = document.querySelector('#tablaResultados tbody');
    tbody.innerHTML = '';
    document.getElementById('tablaResultados').hidden = true;
  }

  map.on('click', function(e) {
    if (!modoRadio) return;
    if (radioCapa) {
      map.removeLayer(radioCapa);
      radioCapa = null;
    }

    radioCapa = L.circle(e.latlng, {
      radius: 500,
      color: 'red',
      fillColor: '#f03',
      fillOpacity: 0.2
    }).addTo(map);

    let resultados = [];

    for (const tipo in subcapas) {
      if (map.hasLayer(subcapas[tipo])) {
        subcapas[tipo].eachLayer(function(layer) {
          if (layer.getLatLng && e.latlng.distanceTo(layer.getLatLng()) <= 500) {
            resultados.push({
              incidente: tipo,
              alcaldia: layer.getPopup().getContent().match(/<b>AlcaldÃ­a:<\/b> ([^<]+)/)[1],
              colonia: layer.getPopup().getContent().match(/<b>Colonia:<\/b> ([^<]+)/)[1],
              latitud: layer.getLatLng().lat.toFixed(6),
              longitud: layer.getLatLng().lng.toFixed(6)
            });
          }
        });
      }
    }

    const tbody = document.querySelector('#tablaResultados tbody');
    tbody.innerHTML = '';
    if (resultados.length > 0) {
      resultados.forEach(r => {
        let tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.incidente}</td><td>${r.alcaldia}</td><td>${r.colonia}</td><td>${r.latitud}</td><td>${r.longitud}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('tablaResultados').hidden = false;
    } else {
      document.getElementById('tablaResultados').hidden = true;
    }

    radioCapa.bindPopup(`Incidentes en el radio: <strong>${resultados.length}</strong>`).openPopup();
  });
</script>

</body>
</html>
