<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Visor de Incendios con Nivel de Riesgo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
/>
<style>
  #map { height: 90vh; }
  .info-popup {
    max-width: 300px;
    font-family: Arial, sans-serif;
    font-size: 14px;
  }
  .info-popup h3 {
    margin: 0 0 5px;
    font-size: 16px;
  }
  .info-popup table {
    border-collapse: collapse;
    width: 100%;
  }
  .info-popup th, .info-popup td {
    border: 1px solid #ccc;
    padding: 5px;
    text-align: left;
  }
  .info-popup th {
    background: #f0f0f0;
  }
</style>
</head>
<body>
<h2 style="text-align:center; font-family: Arial, sans-serif;">Visor de Incendios Urbanos con Nivel de Riesgo</h2>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script>
// Datos de riesgos
const riesgos = {
  "Incendios forestales": {
    probabilidad: "Alto",
    impacto: "Alto",
    riesgo: "Alto",
    accionPreventiva: "En la zona se registraron 142 reportes relacionados con incendios forestales y quema de pastizal, vinculados a vegetación seca y condiciones climáticas de sequía estacional. Se recomienda vigilancia constante, capacitación, campañas preventivas, regulación y sanciones."
  }
};

// Ejemplo datos geojson simplificado
const incendios = {
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "properties": { "incidente_c4": "Incendios forestales", "alcaldia_cierre": "MIGUEL HIDALGO" },
      "geometry": { "type": "Point", "coordinates": [-99.202334, 19.44867] }
    },
    {
      "type": "Feature",
      "properties": { "incidente_c4": "Casa habitacion", "alcaldia_cierre": "Coyoacan" },
      "geometry": { "type": "Point", "coordinates": [-99.145727, 19.331269] }
    }
    // Agrega más puntos aquí
  ]
};

const map = L.map('map').setView([19.43, -99.13], 11);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

let radioCapa = null;

function puntoDentroRadio(latlng, centro, radio) {
  return centro.distanceTo(latlng) <= radio;
}

map.on('click', function(e) {
  // Quitar círculo anterior
  if (radioCapa) {
    map.removeLayer(radioCapa);
  }
  
  const radio = 1000; // metros
  const centro = e.latlng;
  
  // Filtrar puntos dentro del radio
  const puntosDentro = incendios.features.filter(f => {
    const coords = [f.geometry.coordinates[1], f.geometry.coordinates[0]];
    const punto = L.latLng(coords);
    return puntoDentroRadio(punto, centro, radio);
  });

  // Contar incidencias y riesgo máximo
  let riesgoMax = "Bajo";
  const nivelesRiesgo = { "Bajo": 1, "Medio": 2, "Alto": 3 };
  let maxNivel = 0;
  let amenazaMasRelevante = null;

  puntosDentro.forEach(p => {
    const amenaza = p.properties.incidente_c4;
    if (riesgos[amenaza]) {
      const nivel = nivelesRiesgo[riesgos[amenaza].riesgo] || 1;
      if (nivel > maxNivel) {
        maxNivel = nivel;
        riesgoMax = riesgos[amenaza].riesgo;
        amenazaMasRelevante = amenaza;
      }
    }
  });

  // Elegir color según riesgo
  let colorCirculo = '#28a745'; // verde bajo
  if (riesgoMax === "Alto") colorCirculo = '#dc3545';
  else if (riesgoMax === "Medio") colorCirculo = '#ffc107';

  radioCapa = L.circle(centro, {
    radius: radio,
    color: colorCirculo,
    fillColor: colorCirculo,
    fillOpacity: 0.3
  }).addTo(map);

  // Crear contenido del popup
  let contenido = `<div class="info-popup">
    <b>Incidentes en radio ${radio} m:</b> ${puntosDentro.length}<br>
    <b>Nivel de riesgo:</b> ${riesgoMax}<br><br>`;

  if (amenazaMasRelevante) {
    const info = riesgos[amenazaMasRelevante];
    contenido += `<h3>${amenazaMasRelevante}</h3>
      <table>
        <tr><th>Probabilidad</th><td>${info.probabilidad}</td></tr>
        <tr><th>Impacto</th><td>${info.impacto}</td></tr>
        <tr><th>Riesgo</th><td>${info.riesgo}</td></tr>
        <tr><th>Acción preventiva</th><td>${info.accionPreventiva}</td></tr>
      </table>`;
  } else {
    contenido += `<p>No hay información detallada de riesgos para los incidentes en esta área.</p>`;
  }

  contenido += `</div>`;

  radioCapa.bindPopup(contenido).openPopup();
});
</script>
</body>
</html>
